## Context

Claude Code 需要能在編寫或除錯 Go 代碼時查詢最新的標準庫和依賴套件實現。目前依賴 LLM 的訓練數據，容易使用過時的 API 或廢棄的函數。該 skill 旨在讓 LLM 在遇到 LSP 報警、編譯錯誤或廢棄 API 警告時，自動查詢本機和遠端的 Go 源碼，取得最準確的 API 簽名、doc comments 和實現細節。

## Goals / Non-Goals

**Goals:**
- 在 LSP 報警、編譯錯誤、廢棄 API 偵測時自動觸發查詢
- 優先查詢本機 Go 環境（$GOROOT/src 和 $GOPATH/pkg/mod），減少網路依賴
- 返回準確的 API 簽名、doc comments 和源碼片段
- 支援標準庫和第三方套件（基於 go.mod）
- 提供版本資訊（Go 版本、套件版本）

**Non-Goals:**
- 不提供互動式查詢界面（使用者不直接調用）
- 不包括完整的源碼解析或代碼生成
- 不支援跨版本對比（只查詢當前版本）
- 不修改代碼（只提供資訊給 LLM 參考）

## Decisions

### 1. 查詢優先級（本機優先）
**決策**：本機 $GOROOT/src → 本機 $GOPATH/pkg/mod → 遠端 pkg.go.dev API/WebFetch

**理由**：
- 本機源碼準確反映實際開發環境
- 減少網路呼叫，提高速度
- 避免版本不符的問題

**考慮過的方案**：
- 只查本機：無法處理套件未本地安裝的情況
- 直接查遠端：可能與本機版本不符

### 2. 觸發條件（三種情景）
**決策**：LSP 報警、編譯錯誤、廢棄 API 偵測

**理由**：
- 這三種都是可客觀偵測的信號
- 避免過度查詢（不是每行代碼都查）
- 清晰的決策樹，易於實現

**考慮過的方案**：
- 模糊觸發（如"不確定的 API"）：難以實現，容易誤觸發
- 被動式（使用者調用）：無法主動規避過時 API

### 3. 返回資訊粒度
**決策**：函數簽名 + doc comments + 相關源碼片段 + 版本資訊

**理由**：
- LLM 需要足夠資訊做決策
- 不返回完整檔案，避免上下文爆炸
- Doc comments 通常包含使用建議和棄用警告

**考慮過的方案**：
- 只返回簽名：資訊不足
- 返回完整源碼：上下文過大，LLM 難以處理

### 4. 第三方套件版本決定
**決策**：查詢 go.mod 指定的版本，不查最新版本

**理由**：
- 與當前專案一致
- 避免相容性問題
- 如果需要新版本，應由使用者明確升級 go.mod

### 5. 實現方式
**決策**：Bash + Grep/Read 本機，WebFetch 遠端

**理由**：
- 本機查詢用現有 tools（Bash 讀 $GOROOT/$GOPATH，Grep 搜尋）
- 遠端查詢用 WebFetch 查 pkg.go.dev
- 無需新增外部依賴

## Risks / Trade-offs

| 風險 | 緩解方案 |
|------|--------|
| 本機環境不同（Go 版本、套件版本）導致查詢結果與使用者環境不符 | 在返回結果中包含版本資訊，讓 LLM 警覺版本差異 |
| 遠端查詢失敗（網路問題、pkg.go.dev 不可用） | 忽略遠端查詢，依賴本機資訊；提供日誌便於除錯 |
| 查詢本機套件時，$GOPATH 未設定或多個 GOPATH | 使用標準 Go 命令推導（go env GOPATH），支援多路徑 |
| 查詢過程緩慢（大型源碼檔案） | 限制返回片段大小；優先搜尋 doc comments 和簽名行 |
| LSP/編譯錯誤信號噪音（同一問題多次觸發） | 實現簡單去重（同一查詢 15 分鐘內不重複觸發） |

## Migration Plan

該 skill 不涉及代碼變更或資料遷移，採用逐步啟用：

1. **Phase 1**：實現基本查詢邏輯（本機 + 遠端）
2. **Phase 2**：集成三種觸發條件（LSP/編譯/廢棄）
3. **Phase 3**：效能優化和去重邏輯

部署時無需特殊準備；使用者無感知。

## Open Questions

- **LLM 如何偵測編譯錯誤？** 是否需要在 Claude Code 的 Bash tool 執行後自動檢測 go build 輸出？
- **廢棄 API 偵測的準度**：doc comments 中的 Deprecated 標籤格式統一嗎？是否需要模糊匹配？
- **去重時間窗口**：15 分鐘是否合理？還是應該按查詢內容 hash？
- **WebFetch 的備選方案**：pkg.go.dev 不可用時有沒有其他遠端源？（如 GitHub raw）
